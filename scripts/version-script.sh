#!/bin/sh

# This script is run by Xcode during the build phase to generate information about
# the build in C header file format.  When run it produces a file which is included by main.m.
# Copy and paste this file into into Xcodes script window.

# for finding Fossil
PATH=$PATH:/usr/local/bin

OF=XXXX-Tempfile.h
echo  Fossil checked-in files checking script
echo '// *** This file is automatically generated - do not edit ***' >${OF}
echo 'char buildinfo[]=' >>${OF}

unchecked_files=`fossil changes | wc -l`  

printf '"Unique identifier identifying the source code\\n"\n' >> ${OF}
printf '" used to generate this build of %s:\\n"\n' "$PRODUCT_NAME">>${OF}
uuid=Unknown
if test -f ../manifest.uuid 
 then 
  uuid=`cat ../manifest.uuid`
 fi
printf '"%s\\n"\n'  "$uuid" >>${OF}
if [ $unchecked_files -ne 0 ]
	then
	printf '"Warning: unchecked files = %d\\n"\n' $unchecked_files >> ${OF}
	printf '"==== UUID does not reflect build files ====\\n"\n' >>${OF}
	fi
printf '"\\n"\n' >>${OF}
printf '"Build machine hostname: %s\\n"\n' `hostname -f` >> ${OF}
printf '"Built by username: %s\\n\\n"\n' `whoami` >> ${OF}
builddate=`TZ=UTC date`
printf '"Built on: %s\\n\\n"\n' "$builddate"  >> ${OF}
printf '"   === Version control status ===\\n"\n' >>${OF}
fossil status  | \
	while read i
		do	
			printf '"%s\\n"\n' "$i"
		done  >> ${OF}
if [ $unchecked_files -ne 0 ]	
then
printf '"Warning: %d unchecked files (this is bad)\\n"\n' $unchecked_files >>${OF}
printf '"         It means that the UUID does not reflect the state of the files used\\n"\n' >> ${OF}
printf '"         for this build.\\n"\n' >> ${OF}
fi		
printf '"\\n"\n' >>${OF}
printf '"Archs: %s\\n"\n' "${ARCHS}" >>${OF} 
printf '"Build Style: %s\\n"\n' "${BUILD_STYLE}" >>${OF}
printf '"Build Variants: %s\\n"\n' "${BUILD_VARIANTS}" >>${OF}
printf '"Debugging Symbols:%s\\n"\n' "${DEBUGGING_SYMBOLS}" >>${OF}
printf '"Debug Information Format: %s\\n"\n' "${DEBUG_INFORMATION_FORMAT}" >>${OF}
printf '"GCC Version: %s\\n"\n' "${GCC_VERSION}" >>${OF}
printf '"MacOSX Deployment Target: %s\\n"\n' "${MACOSX_DEPLOYMENT_TARGET}" >>${OF}
printf '"Build Machine OSX Version Actual: %s\\n"\n' "${MAC_OS_X_VERSION_ACTUAL}" >>${OF}
printf '"Build Machine OSX Version Major: %s\\n"\n' "${MAC_OS_X_VERSION_MAJOR}" >>${OF}
printf '"Build Machine OSX Version Minor: %s\\n"\n' "${MAC_OS_X_VERSION_MINOR}" >>${OF}
printf '"Product Name: %s\\n"\n' "${PRODUCT_NAME}" >>${OF}
printf '"SDK Root: %s\\n"\n' "${SDKROOT}" >>${OF}
printf '"SDK Name: %s\\n"\n' "${SDK_NAME}" >>${OF}
printf '"Xcode Version Actual: %s\\n"\n' "${XCODE_VERSION_ACTUAL}" >>${OF}
printf '"Xcode Version Major: %s\\n"\n' "${XCODE_VERSION_MAJOR}" >>${OF}
printf '"Xcode Version Minor: %s\\n"\n' "${XCODE_VERSION_MINOR}" >>${OF}
echo \; >>${OF}
printf 'int unchecked_files = %d;\n' $unchecked_files >>${OF}
printf 'char source_code_fossil_uuid[]="%s";\n' $uuid >>${OF}
if [ $unchecked_files -ne 0 ]
	then 
		echo ERROR files not checked into Fossil
		exit 0
	else
		exit 0
	fi
